---
description: author:huahua
---

# 🦎 iptables食用指南

## iptables简介

iptables - 用于 IPv4 数据包过滤和 NAT 的管理工具（就是个filter，但是可以玩的很花）

* **iptables \[-t table] -\[AD] chain rule-specification \[options]**&#x20;
* **iptables \[-t table] -I chain \[rulenum] rule-specification \[options]**&#x20;
* **iptables \[-t table] -R chain rulenum rule-specification \[options ]**&#x20;
* **iptables \[-t 表] -D chain rulenum \[选项]**&#x20;
* **iptables \[-t 表] -\[LFZ] \[链] \[选项]**&#x20;
* **iptables \[-t 表] -N链**&#x20;
* **iptables \[-t 表] -X \[链]**&#x20;
* **iptables \[-t table] -P chain target \[options]**
* **iptables \[-t table] -E old-chain-name new-chain-name**

iptables用于在 Linux 内核中建立、维护和检查 IP 数据包过滤规则表。可以定义几个不同的表。每个表都包含许多内置链，也可能包含用户定义的链。

每个链都是可以匹配一组数据包的规则列表。每个规则指定如何处理匹配的数据包。这称为“目标”，它可能是跳转到同一表中的用户定义链。

### 目标：

防火墙规则指定数据包和目标的标准。如果数据包不匹配，则检查链中的下一条规则；如果匹配，则下一条规则由目标值指定，目标值可以是用户定义链的名称或特殊值 **ACCEPT 、 DROP 、 QUEUE或RETURN**之一。

ACCEPT表示让数据包通过。DROP表示将数据包丢弃。QUEUE表示将数据包传递给用户空间。（用户空间进程如何接收数据包因特定的队列处理程序而异。2.4.x 和 2.6.x 内核直到 2.6.13 包括 ip\_queue 队列处理程序。 内核 2.6.14 和更高版本还包括nfnetlink\_queue队列处理程序。在这种情况下，目标为 QUEUE 的数据包将被发送到队列号“0”。）返回意味着停止遍历此链并在先前（调用）链中的下一条规则处恢复。如果到达内置链的末尾或匹配了 带有目标RETURN的内置链中的规则，则链策略指定的目标将决定数据包的命运。

### 表

目前有三个独立的表（哪些表随时存在取决于内核配置选项和存在哪些模块）

\-t, --table _表_此选项指定命令应操作的数据包匹配表。如果内核配置了自动模块加载，则将尝试为该表加载适当的模块（如果该表不存在）。

表格如下：

**filter：这是默认表（如果未传递 -t 选项）。它包含内置链INPUT（用于发往本地套接字的数据包）、FORWARD （用于通过盒子路由的数据包）和OUTPUT（用于本地生成的数据包）。**

**nat：当遇到创建新连接的数据包时，将查询此表。它由三个内置函数组成：PREROUTING（用于在数据包进入时立即更改）、OUTPUT（用于在路由之前更改本地生成的数据包）和POSTROUTING（用于在数据包即将离开时更改）。**

**mangle：该表用于专门的数据包更改。在内核 2.4.17 之前，它有两个内置链：PREROUTING（用于在路由之前更改传入的数据包）和OUTPUT（用于在路由之前更改本地生成的数据包）。从内核 2.4.18 开始，还支持其他三个内置链： INPUT（用于进入盒子本身的数据包）、FORWARD（用于改变通过盒子路由的数据包）和POSTROUTING（用于改变数据包，因为它们即将到达）出去）。**

**raw：该表主要用于结合 NOTRACK 目标配置连接跟踪豁免。它在具有更高优先级的 netfilter 挂钩上注册，因此在 ip\_conntrack 或任何其他 IP 表之前被调用。它提供以下内置链：PREROUTING（用于通过任何网络接口到达的数据包）OUTPUT（用于本地进程生成的数据包）**



### 命令

这些选项指定要执行的特定操作。除非下面另有说明，否则只能在命令行中指定其中之一。对于所有长版本的命令和选项名称，您只需要使用足够的字母以确保iptables可以将其与所有其他选项区分开来。

* **-A, --append **_**链规则规范**_**将一个或多个规则附加到所选链的末尾。当源名称和/或目标名称解析为多个地址时，将为每个可能的地址组合添加一条规则。**
* **-D, --delete 链规则规范**
* **-D, --delete 链规则编号从所选链中删除一个或多个规则。此命令有两个版本：规则可以指定为链中的数字（第一个规则从 1 开始）或要匹配的规则。**
* **-I, --insert chain \[ rulenum ]规则规范在选定的链中插入一个或多个规则作为给定的规则编号。因此，如果规则编号为 1，则将规则或规则插入到链的头部。如果未指定规则编号，这也是默认值。**
* **-R, --replace chain rulenum 规则规范替换所选链中的规则。如果源和/或目标名称解析为多个地址，该命令将失败。规则从 1 开始编号。**
* **-L, --list \[链]列出所选链中的所有规则。如果未选择任何链，则会列出所有链。与所有其他 iptables 命令一样，它适用于指定的表（过滤器是默认值），因此 NAT 规则被列出**

```
iptables -t nat -n -L
```

请注意，它通常与-n选项一起使用，以避免长时间的反向 DNS 查找。指定-Z（零）选项也是合法的，在这种情况下，链将自动列出并归零。确切的输出受给定的其他参数的影响。在您使用之前，将抑制确切的规则

```
iptables -L -v
```

* **-F, --flush \[**_**链**_**]刷新选定的链（如果没有给出，则表中的所有链）。这相当于把所有的规则都一条条删掉了。**
* **-Z, --zero \[**_**链**_**]将所有链中的数据包和字节计数器清零。指定-L, --list (list) 选项也是合法的，以便在清除计数器之前立即查看计数器。（往上看。）**
* **-N, --new-chain **_**链**_**按给定名称创建新的用户定义链。必须已经没有该名称的目标。**
* **-X, --delete-chain \[**_**链**_**]删除指定的可选用户定义链。必须没有对链的引用。如果有，您必须先删除或替换引用规则，然后才能删除链。链必须是空的，即不包含任何规则。如果没有给出参数，它将尝试删除表中的每个非内置链。**
* **-P, --策略 **_**链目标**_**将链的策略设置为给定的目标。只有内置（非用户定义）链可以有策略，内置链和用户定义链都不能作为策略目标。**
* **-E, --rename-chain **_**旧链 新链**_**将用户指定的链重命名为用户提供的名称。这是装饰性的，对表格的结构没有影响。**
* **-H, 帮助。给出命令语法的（目前非常简短的）描述。**

### 参数

以下参数构成规则规范（用于添加、删除、插入、替换和追加命令）。

* **-p, --protocol \[!]协议要检查的规则或数据包的协议。指定的协议可以是tcp、udp、icmp或all之一，也可以是数值，代表这些协议之一或不同的协议。来自 /etc/protocols 的协议名称也是允许的。A ”！” 协议反转测试之前的参数。数字零等同于所有。Protocol all将与所有协议匹配，并在省略此选项时默认使用。**
* **-s, --source \[!]地址\[/掩码]来源规范。地址可以是网络名称、主机名（请注意，指定要通过远程查询解析的任何名称（例如 DNS）是一个非常糟糕的主意）、网络 IP 地址（带有 /mask）或纯 IP 地址。掩码可以是网络掩码或纯数字，指定网络掩码左侧 1 的数量。因此，掩码24相当于255.255.255.0。A ”！” 地址规范之前的参数会反转地址的含义。标志--src是此选项的别名。**
* **-d, --destination \[!]地址\[/掩码]目的地规范。有关语法的详细描述，请参阅-s （源）标志的描述。标志--dst是此选项的别名。**
* **-j, --跳跃 目标这指定了规则的目标；即，如果数据包匹配它该怎么办。目标可以是用户定义的链（除了这条规则所在的链），可以立即决定数据包命运的特殊内置目标之一，或扩展（请参阅下面的扩展）。如果在规则中省略此选项（并且未使用-g），则匹配规则将不会影响数据包的命运，但规则上的计数器将递增。**
* **-g, --goto **_**链**_**这指定处理应在用户指定的链中继续。与 --jump 选项不同，return 不会继续在此链中处理，而是在通过 --jump 调用我们的链中继续处理。**
* **-i, --in-interface \[!]**_**名称**_**接收数据包的接口名称（仅适用于进入INPUT、FORWARD和PREROUTING链的数据包）。当。。。的时候 ”！” 参数用在接口名称之前，意思是颠倒的。如果接口名称以“+”结尾，则以该名称开头的任何接口都将匹配。如果省略此选项，将匹配任何接口名称。**
* **-o, --out-interface \[!]**_**名称**_**将要发送数据包的接口名称（对于进入FORWARD、OUTPUT和POSTROUTING链的数据包）。当。。。的时候 ”！” 参数用在接口名称之前，意思是颠倒的。如果接口名称以“+”结尾，则以该名称开头的任何接口都将匹配。如果省略此选项，将匹配任何接口名称。**
* **\[!] -f, --片段这意味着该规则仅涉及分片数据包的第二个和更多分片。由于无法分辨此类数据包（或 ICMP 类型）的源端口或目标端口，因此此类数据包将不匹配指定它们的任何规则。当。。。的时候 ”！” 参数在“-f”标志之前，规则将只匹配头部片段，或未分段的数据包。**
* **-c, --set-counters **_**PKTS 字节**_**这使管理员能够初始化规则的数据包和字节计数器（在INSERT、APPEND、REPLACE操作期间）。**

其他选项

可以指定以下附加选项：

* **-v, --详细详细输出。此选项使列表命令显示接口名称、规则选项（如果有）和 TOS 掩码。还列出了数据包和字节计数器，后缀“K”、“M”或“G”分别表示 1000、1,000,000 和 1,000,000,000 倍数（但请参阅**&#x20;
* **-x 标志以更改此值）。对于追加、插入、删除和替换，这会导致打印有关一条或多条规则的详细信息。**
* **-n, --数字数字输出。IP 地址和端口号将以数字格式打印。默认情况下，程序会尝试将它们显示为主机名、网络名或服务（只要适用）。**
* **-x, --精确展开数字。显示数据包和字节计数器的准确值，而不是仅显示 K（1000 的倍数）M（1000K 的倍数）或 G（1000M 的倍数）中的四舍五入数。此选项仅与-L命令相关。--行号列出规则时，将行号添加到每个规则的开头，对应于该规则在链中的位置。**
* **--modprobe=命令在链中添加或插入规则时，使用命令加载任何必要的模块（目标、匹配扩展等）。**

### 匹配扩展













参考链接

[https://linux.die.net/man/8/iptables](https://linux.die.net/man/8/iptables)(man 手册)











